# Расположение бизнес-логики микросервисов

Документ описывает, где находится бизнес-логика в каждом микросервисе ERP системы.

## Общая структура

В большинстве микросервисов бизнес-логика разделена на два уровня:
1. **Сервисные классы** (`*_service.py`) - основная бизнес-логика
2. **Роутеры** (`routers/*.py`) - HTTP endpoints, которые вызывают сервисные классы

---

## 1. Auth Service (Сервис аутентификации)

### Расположение бизнес-логики:
- **`backend/auth_service/app/auth_service.py`** - основной класс `AuthService` с бизнес-логикой

### Основные методы:
- `validate_user()` - валидация пользователя (проверка логина/пароля)
- `login()` - логика входа пользователя (валидация + отправка события в RabbitMQ)
- `logout()` - логика выхода пользователя (отправка события в RabbitMQ)

### Роутеры:
- **`backend/auth_service/app/routers/auth.py`** - HTTP endpoints, которые вызывают методы `AuthService`

---

## 2. Catalog Service (Сервис каталога товаров)

### Расположение бизнес-логики:
- **`backend/catalog_service/app/routers/catalog.py`** - бизнес-логика находится непосредственно в роутерах

### Основные функции:
- `create_sku()` - создание товара (валидация, проверка уникальности артикула, создание операции в Inventory Service)
- `update_sku()` - обновление товара (валидация единиц измерения, обновление операции в Inventory Service)
- `delete_sku()` - удаление товара (создание операции удаления в Inventory Service)
- `import_skus_csv()` - импорт товаров из CSV (парсинг, валидация, маппинг статусов)
- `export_skus_csv()` - экспорт товаров в CSV

### Особенности:
- Бизнес-логика не вынесена в отдельный сервисный класс, находится в роутерах
- При создании/обновлении/удалении товара автоматически создаются операции в Inventory Service
- Отправка событий в RabbitMQ при изменениях товаров

---

## 3. Inventory Service (Сервис управления остатками)

### Расположение бизнес-логики:
- **`backend/inventory_service/app/inventory_service.py`** - основной класс `InventoryService` с бизнес-логикой

### Основные методы:
- `calculate_delta_value()` - расчет итогового значения (количество * коэффициент_количества * вес * коэффициент_веса)
- `create_operation()` - создание операции и обновление остатков
- `create_operation_with_delta()` - создание операции с заданным delta_value (для операций delete)
- `_update_totals()` - обновление остатков после операции (приватный метод)
- `_update_sku_total()` - обновление абсолютных остатков по SKU
- `_update_location_total()` - обновление остатков по локации

### Роутеры:
- **`backend/inventory_service/app/routers/inventory.py`** - HTTP endpoints, которые вызывают методы `InventoryService`

### Особенности:
- Логика расчета остатков (абсолютных и по локациям)
- Обработка различных типов операций: transfer, receipt, create, write_off, delete, update
- Интеграция с Catalog Service для получения коэффициентов единиц измерения

---

## 4. Warehouse Service (Сервис управления складом)

### Расположение бизнес-логики:
- **`backend/warehouse_service/app/warehouse_service.py`** - основной класс `WarehouseService` с бизнес-логикой

### Основные методы:

#### Управление локациями:
- `get_location_stats()` - получение статистики по локациям (синхронизация с Inventory Service)
- `update_location_capacity()` - обновление заполненности локации
- `check_capacity()` - проверка доступного места в локации
- `get_location_by_name()` - получение локации по имени
- `get_temp_storage_location()` - получение или создание временного хранилища
- `get_main_storage_location()` - получение основного хранилища
- `get_warehouse_locations()` - получение всех складов

#### Обработка операций:
- `process_operation()` - главный метод обработки операций (роутинг по типам операций)
- `_process_receipt()` - прием товара складом из хранилища
- `_process_shipment()` - отгрузка товара со склада в хранилище
- `_process_transfer()` - перемещение между складами
- `_process_global_distribution_all()` - глобальное распределение (все товары) равномерно по 4 складам
- `_process_global_distribution_sku()` - глобальное распределение (выбранный товар) равномерно по 4 складам
- `_process_replenishment_all()` - пополнение запасов (все товары) в выбранный склад со всех складов
- `_process_replenishment_sku()` - пополнение запасов (выбранный товар) в выбранный склад со всех локаций
- `_process_placement_all()` - размещение запасов (все товары) из выбранного склада равномерно по остальным 3 складам
- `_process_placement_sku()` - размещение запасов (выбранный товар) из выбранного склада равномерно по остальным 3 складам
- `_move_to_temp_storage()` - перемещение товара во временное хранилище
- `process_temp_storage_migration()` - обработка перемещения товаров из временного хранилища в основное (через 5 минут)

### Роутеры:
- **`backend/warehouse_service/app/routers/warehouse.py`** - HTTP endpoints, которые вызывают методы `WarehouseService`

### Особенности:
- Сложная логика распределения товаров между складами
- Обработка излишков товаров (перемещение во временное хранилище)
- Интеграция с Inventory Service для получения остатков и создания операций
- Интеграция с Catalog Service для получения информации о товарах
- Фоновая обработка операций через BackgroundTasks

---

## 5. Orders Service (Сервис управления заказами)

### Расположение бизнес-логики:
- **`backend/orders_service/app/main.py`** - только базовые endpoints (health check)

### Статус:
- ⚠️ **Минимальная реализация** - сервис содержит только заглушки
- Бизнес-логика не реализована

---

## 6. Notifications Service (Сервис уведомлений)

### Расположение бизнес-логики:
- **`backend/notifications_service/app/main.py`** - только базовые endpoints (health check)

### Статус:
- ⚠️ **Минимальная реализация** - сервис содержит только заглушки
- Бизнес-логика не реализована

---

## 7. API Gateway

### Расположение бизнес-логики:
- **`backend/api_gateway/app/proxy.py`** - логика проксирования запросов

### Основные функции:
- `proxy_request()` - проксирование HTTP запросов к микросервисам
- Передача заголовков (включая роль пользователя)
- Маршрутизация запросов

### Особенности:
- Не содержит бизнес-логики, только маршрутизация и проксирование

---

## Резюме

### Сервисы с вынесенной бизнес-логикой (Service Layer):
1. ✅ **Auth Service** - `auth_service.py`
2. ✅ **Inventory Service** - `inventory_service.py`
3. ✅ **Warehouse Service** - `warehouse_service.py`

### Сервисы с бизнес-логикой в роутерах:
1. ⚠️ **Catalog Service** - логика в `routers/catalog.py` (рекомендуется вынести в отдельный сервисный класс)

### Сервисы без бизнес-логики:
1. ⚠️ **Orders Service** - только заглушки
2. ⚠️ **Notifications Service** - только заглушки
3. ℹ️ **API Gateway** - только маршрутизация

---

## Рекомендации по архитектуре

1. **Catalog Service**: Рекомендуется вынести бизнес-логику из роутеров в отдельный класс `CatalogService` для лучшей организации кода и тестируемости.

2. **Orders Service и Notifications Service**: Требуется реализация бизнес-логики в соответствии с требованиями системы.

3. **Service Layer Pattern**: Три сервиса (Auth, Inventory, Warehouse) уже используют паттерн Service Layer, что является хорошей практикой для разделения бизнес-логики и HTTP endpoints.


